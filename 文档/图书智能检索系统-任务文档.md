# 基于Microsoft Agent Framework的图书智能检索聊天系统

## 项目概述

### 项目名称
图书智能检索聊天系统 (Intelligent Book Search Chat System)

### 项目背景
本项目旨在利用Microsoft Agent Framework构建一个智能图书检索系统,通过自然语言对话方式,帮助用户快速检索图书数据库中的信息。系统将SQL Server图书数据库与AI Agent技术结合,提供智能化的图书查询、推荐和问答服务。

### 技术栈
- **AI框架**: Microsoft Agent Framework (Semantic Kernel + AutoGen)
- **数据库**: Microsoft SQL Server
- **开发语言**: C# (.NET 8.0+) 或 Python 3.10+
- **AI模型**: Azure OpenAI / OpenAI GPT-4
- **其他技术**: MCP (Model Context Protocol), RAG (检索增强生成)

---

## 一、项目目标

### 1.1 核心功能
1. **自然语言查询**: 用户通过对话方式查询图书信息
2. **智能检索**: AI Agent自动将自然语言转换为SQL查询
3. **多轮对话**: 支持上下文理解的多轮交互
4. **图书推荐**: 基于用户需求智能推荐相关图书
5. **信息问答**: 回答关于图书的各类问题

### 1.2 技术目标
1. 掌握Microsoft Agent Framework的使用
2. 实现Text-to-SQL功能
3. 构建RAG系统集成数据库
4. 实现Agent工具调用和MCP集成
5. 完成完整的AI应用开发流程

---

## 二、系统架构设计

### 2.1 整体架构

```
用户输入 (自然语言)
    ↓
Agent Framework (AI Agent)
    ↓
┌─────────────┬─────────────┬─────────────┐
│  LLM理解   │  工具调用   │  MCP服务器  │
│  (GPT-4)   │  (Tools)    │  (SQL)      │
└─────────────┴─────────────┴─────────────┘
    ↓
SQL Server 图书数据库
    ↓
结果处理与生成
    ↓
用户输出 (自然语言回答)
```

### 2.2 核心组件

#### 2.2.1 AI Agent层
- **ChatCompletionAgent**: 主对话代理
- **Tools**: SQL查询工具、推荐工具
- **Memory**: 对话历史管理
- **Middleware**: 日志、安全过滤

#### 2.2.2 数据访问层
- **MCP Server**: SQL Server连接器
- **Query Generator**: Text-to-SQL转换
- **Result Parser**: 结果解析器

#### 2.2.3 业务逻辑层
- **Book Search Service**: 图书检索服务
- **Recommendation Engine**: 推荐引擎
- **Context Manager**: 上下文管理

---

## 三、数据库设计

### 3.1 图书数据库表结构

假设现有SQL Server数据库包含以下表:

#### 表1: Books (图书表)
```sql
CREATE TABLE Books (
    BookID INT PRIMARY KEY,
    Title NVARCHAR(200),
    Author NVARCHAR(100),
    Publisher NVARCHAR(100),
    PublishDate DATE,
    ISBN VARCHAR(20),
    Category NVARCHAR(50),
    Price DECIMAL(10,2),
    Stock INT,
    Description NVARCHAR(MAX)
);
```

#### 表2: Authors (作者表)
```sql
CREATE TABLE Authors (
    AuthorID INT PRIMARY KEY,
    AuthorName NVARCHAR(100),
    Biography NVARCHAR(MAX),
    Country NVARCHAR(50)
);
```

#### 表3: Categories (分类表)
```sql
CREATE TABLE Categories (
    CategoryID INT PRIMARY KEY,
    CategoryName NVARCHAR(50),
    ParentCategoryID INT
);
```

#### 表4: BorrowRecords (借阅记录表)
```sql
CREATE TABLE BorrowRecords (
    RecordID INT PRIMARY KEY,
    BookID INT,
    UserID INT,
    BorrowDate DATE,
    ReturnDate DATE,
    Status NVARCHAR(20)
);
```

### 3.2 数据库连接配置

```json
{
  "ConnectionStrings": {
    "BookDatabase": "Server=localhost;Database=BookLibrary;Trusted_Connection=True;"
  }
}
```

---

## 四、技术实现方案

### 4.1 环境搭建

#### 4.1.1 安装依赖 (.NET)
```bash
dotnet add package Microsoft.Agents.AI
dotnet add package Microsoft.SemanticKernel
dotnet add package Microsoft.Data.SqlClient
dotnet add package Azure.AI.OpenAI
```

#### 4.1.2 安装依赖 (Python)
```bash
pip install agent-framework
pip install semantic-kernel
pip install pyodbc
pip install openai
```

### 4.2 核心代码实现

#### 4.2.1 创建AI Agent (C#示例)

```csharp
using Microsoft.Agents.AI;
using Microsoft.SemanticKernel;

// 1. 配置AI模型
var builder = Kernel.CreateBuilder();
builder.AddAzureOpenAIChatCompletion(
    deploymentName: "gpt-4",
    endpoint: "your-endpoint",
    apiKey: "your-api-key"
);

// 2. 添加SQL查询工具
builder.Plugins.AddFromType<BookSearchPlugin>();

var kernel = builder.Build();

// 3. 创建Agent
var agent = new ChatCompletionAgent
{
    Name = "BookSearchAgent",
    Instructions = @"你是一个图书馆智能助手。
        帮助用户查询图书信息、推荐图书、回答问题。
        使用SQL工具查询数据库获取准确信息。",
    Kernel = kernel
};
```

#### 4.2.2 实现SQL查询工具

```csharp
public class BookSearchPlugin
{
    private readonly string _connectionString;
    
    [KernelFunction("search_books")]
    [Description("根据条件搜索图书")]
    public async Task<string> SearchBooks(
        [Description("图书标题关键词")] string? title = null,
        [Description("作者名称")] string? author = null,
        [Description("分类")] string? category = null)
    {
        using var connection = new SqlConnection(_connectionString);
        await connection.OpenAsync();
        
        var query = BuildSearchQuery(title, author, category);
        using var command = new SqlCommand(query, connection);
        
        var results = new List<Book>();
        using var reader = await command.ExecuteReaderAsync();
        while (await reader.ReadAsync())
        {
            results.Add(new Book
            {
                Title = reader.GetString(0),
                Author = reader.GetString(1),
                Publisher = reader.GetString(2),
                Price = reader.GetDecimal(3)
            });
        }
        
        return JsonSerializer.Serialize(results);
    }
    
    private string BuildSearchQuery(string? title, string? author, string? category)
    {
        var conditions = new List<string>();
        if (!string.IsNullOrEmpty(title))
            conditions.Add($"Title LIKE '%{title}%'");
        if (!string.IsNullOrEmpty(author))
            conditions.Add($"Author LIKE '%{author}%'");
        if (!string.IsNullOrEmpty(category))
            conditions.Add($"Category = '{category}'");
            
        var where = conditions.Any() ? "WHERE " + string.Join(" AND ", conditions) : "";
        return $"SELECT Title, Author, Publisher, Price FROM Books {where}";
    }
}
```

#### 4.2.3 实现对话循环

```csharp
// 创建对话线程
var thread = await agent.CreateThreadAsync();

while (true)
{
    Console.Write("用户: ");
    var userInput = Console.ReadLine();
    if (string.IsNullOrEmpty(userInput)) break;
    
    // 添加用户消息
    await thread.AddUserMessageAsync(userInput);
    
    // 获取Agent响应
    await foreach (var message in agent.InvokeAsync(thread))
    {
        Console.WriteLine($"助手: {message.Content}");
    }
}
```

### 4.3 Text-to-SQL实现

#### 4.3.1 使用Semantic Kernel实现

```csharp
public class TextToSQLService
{
    private readonly Kernel _kernel;
    
    public async Task<string> ConvertToSQL(string naturalLanguageQuery)
    {
        var prompt = $@"
将以下自然语言查询转换为SQL语句。
数据库表结构:
- Books(BookID, Title, Author, Publisher, PublishDate, Category, Price, Stock)
- Authors(AuthorID, AuthorName, Biography, Country)
- Categories(CategoryID, CategoryName, ParentCategoryID)

用户查询: {naturalLanguageQuery}

只返回SQL语句,不要其他解释:
";
        
        var result = await _kernel.InvokePromptAsync(prompt);
        return result.ToString();
    }
}
```

### 4.4 MCP集成 (可选高级功能)

```csharp
// 配置MCP Server连接SQL Server
var mcpClient = new MCPClient();
await mcpClient.ConnectAsync("mssql://localhost/BookLibrary");

// 在Agent中使用MCP工具
builder.Plugins.AddFromMCP(mcpClient);
```

---

## 五、功能实现清单

### 5.1 基础功能 (必须完成)

- [ ] **环境搭建**
  - [ ] 安装.NET SDK / Python环境
  - [ ] 配置Azure OpenAI / OpenAI API
  - [ ] 配置SQL Server数据库连接

- [ ] **数据库准备**
  - [ ] 创建图书数据库表结构
  - [ ] 导入测试数据(至少100条图书记录)
  - [ ] 创建必要的索引

- [ ] **AI Agent开发**
  - [ ] 创建基础ChatCompletionAgent
  - [ ] 配置Agent指令(Instructions)
  - [ ] 实现对话循环

- [ ] **SQL查询工具**
  - [ ] 实现图书搜索工具(按标题/作者/分类)
  - [ ] 实现图书详情查询工具
  - [ ] 实现库存查询工具

- [ ] **对话功能**
  - [ ] 支持多轮对话
  - [ ] 上下文记忆管理
  - [ ] 错误处理和友好提示

### 5.2 进阶功能 (建议完成)

- [ ] **Text-to-SQL**
  - [ ] 自然语言转SQL查询
  - [ ] SQL安全验证(防注入)
  - [ ] 复杂查询支持(JOIN, GROUP BY等)

- [ ] **智能推荐**
  - [ ] 基于分类的推荐
  - [ ] 基于作者的推荐
  - [ ] 基于借阅历史的推荐

- [ ] **RAG增强**
  - [ ] 图书描述向量化
  - [ ] 语义搜索功能
  - [ ] 相似图书推荐

- [ ] **用户体验优化**
  - [ ] 流式输出(Streaming)
  - [ ] 打字机效果
  - [ ] 结果格式化展示

### 5.3 高级功能 (可选)

- [ ] **MCP集成**
  - [ ] 配置MSSQL MCP Server
  - [ ] 使用MCP工具调用数据库

- [ ] **多Agent协作**
  - [ ] 查询Agent + 推荐Agent
  - [ ] Agent工作流编排

- [ ] **Web界面**
  - [ ] 使用Blazor/React构建前端
  - [ ] WebSocket实时通信
  - [ ] 聊天历史保存

---

## 六、开发计划

### 第1周: 环境搭建与基础开发
- Day 1-2: 环境配置,数据库准备
- Day 3-4: 创建基础Agent,实现简单对话
- Day 5-7: 实现SQL查询工具,测试基本功能

### 第2周: 功能完善
- Day 1-3: 实现Text-to-SQL功能
- Day 4-5: 添加推荐功能
- Day 6-7: 优化对话体验,错误处理

### 第3周: 高级功能与测试
- Day 1-2: 实现RAG或MCP集成
- Day 3-4: 全面测试,修复bug
- Day 5-7: 文档编写,代码整理

---

## 七、测试用例

### 7.1 基础查询测试

**测试1: 按标题查询**
```
用户: 帮我找一下关于"人工智能"的书
预期: 返回标题包含"人工智能"的图书列表
```

**测试2: 按作者查询**
```
用户: 有没有吴恩达写的书?
预期: 返回作者为"吴恩达"的图书
```

**测试3: 复杂查询**
```
用户: 我想找计算机类的书,价格在50元以下
预期: 返回分类为"计算机"且价格<50的图书
```

### 7.2 对话测试

**测试4: 多轮对话**
```
用户: 推荐一本机器学习的书
助手: [推荐书籍]
用户: 这本书有库存吗?
预期: Agent理解"这本书"指代上一轮推荐的书
```

### 7.3 推荐测试

**测试5: 智能推荐**
```
用户: 我喜欢深度学习,还有什么相关的书推荐吗?
预期: 推荐相关分类或相似主题的图书
```

---

## 八、技术难点与解决方案

### 8.1 Text-to-SQL准确性
**难点**: LLM生成的SQL可能不准确或不安全

**解决方案**:
1. 提供详细的数据库Schema描述
2. 使用Few-shot示例提高准确率
3. SQL验证和白名单机制
4. 错误重试机制

### 8.2 上下文理解
**难点**: 多轮对话中的指代消解

**解决方案**:
1. 使用Agent Thread管理对话历史
2. 实现Context Provider保存关键信息
3. 在Prompt中明确上下文

### 8.3 性能优化
**难点**: 数据库查询和LLM调用延迟

**解决方案**:
1. 数据库查询优化(索引、缓存)
2. 使用流式输出提升体验
3. 异步处理
4. 结果缓存

---

## 九、参考资料

### 9.1 官方文档
- Microsoft Agent Framework: https://learn.microsoft.com/zh-cn/agent-framework/
- Semantic Kernel: https://learn.microsoft.com/zh-cn/semantic-kernel/
- Azure OpenAI: https://learn.microsoft.com/zh-cn/azure/ai-services/openai/

### 9.2 示例代码
- Agent Framework Samples: https://github.com/microsoft/agent-framework/tree/main/samples
- Semantic Kernel Samples: https://github.com/microsoft/semantic-kernel/tree/main/dotnet/samples

### 9.3 相关技术
- Text-to-SQL: https://blog.yuanpei.me/posts/semantic-kernel-driven-text2sql-practice/
- MCP Protocol: https://modelcontextprotocol.io/
- RAG技术: https://learn.microsoft.com/zh-cn/semantic-kernel/concepts/vector-store-connectors/

---

## 十、交付物

### 10.1 代码交付
- [ ] 完整源代码(GitHub仓库)
- [ ] README.md(项目说明)
- [ ] 配置文件示例
- [ ] 数据库脚本

### 10.2 文档交付
- [ ] 系统设计文档
- [ ] API文档
- [ ] 用户使用手册
- [ ] 开发总结报告

### 10.3 演示交付
- [ ] 功能演示视频
- [ ] PPT演示文稿
- [ ] 现场演示准备

---

## 十一、评估标准

### 11.1 功能完整性 (40分)
- 基础查询功能 (15分)
- 多轮对话 (10分)
- 推荐功能 (10分)
- 错误处理 (5分)

### 11.2 技术实现 (30分)
- Agent Framework使用 (10分)
- Text-to-SQL实现 (10分)
- 代码质量 (10分)

### 11.3 创新性 (15分)
- RAG/MCP集成 (10分)
- 其他创新功能 (5分)

### 11.4 文档与演示 (15分)
- 文档完整性 (8分)
- 演示效果 (7分)

---

## 附录A: 快速开始示例

### 最小可运行示例 (C#)

```csharp
using Microsoft.Agents.AI;
using Microsoft.SemanticKernel;
using Microsoft.Data.SqlClient;

class Program
{
    static async Task Main()
    {
        // 1. 创建Kernel
        var builder = Kernel.CreateBuilder();
        builder.AddAzureOpenAIChatCompletion(
            "gpt-4", 
            "your-endpoint", 
            "your-key"
        );
        
        // 2. 添加SQL工具
        builder.Plugins.AddFromType<BookPlugin>();
        var kernel = builder.Build();
        
        // 3. 创建Agent
        var agent = new ChatCompletionAgent
        {
            Name = "BookBot",
            Instructions = "你是图书馆助手,帮助用户查询图书。",
            Kernel = kernel
        };
        
        // 4. 对话循环
        var thread = await agent.CreateThreadAsync();
        while (true)
        {
            Console.Write("你: ");
            var input = Console.ReadLine();
            if (string.IsNullOrEmpty(input)) break;
            
            await thread.AddUserMessageAsync(input);
            await foreach (var msg in agent.InvokeAsync(thread))
            {
                Console.WriteLine($"助手: {msg.Content}");
            }
        }
    }
}

class BookPlugin
{
    [KernelFunction]
    [Description("搜索图书")]
    public string SearchBooks(string keyword)
    {
        // 简化的SQL查询
        using var conn = new SqlConnection("your-connection-string");
        conn.Open();
        var cmd = new SqlCommand(
            $"SELECT TOP 5 Title, Author FROM Books WHERE Title LIKE '%{keyword}%'", 
            conn
        );
        
        var results = new List<string>();
        using var reader = cmd.ExecuteReader();
        while (reader.Read())
        {
            results.Add($"{reader["Title"]} - {reader["Author"]}");
        }
        
        return string.Join("\n", results);
    }
}
```

---

## 附录B: 常见问题FAQ

**Q1: 如何获取Azure OpenAI API密钥?**
A: 访问Azure Portal → 创建Azure OpenAI资源 → 获取密钥和端点

**Q2: 可以使用免费的OpenAI API吗?**
A: 可以,但需要注册OpenAI账号并获取API Key

**Q3: SQL Server可以用其他数据库替代吗?**
A: 可以,但需要修改连接字符串和SQL语法

**Q4: 如何防止SQL注入?**
A: 使用参数化查询,验证SQL语句,使用白名单机制

**Q5: Agent响应太慢怎么办?**
A: 使用流式输出,优化Prompt,使用更快的模型(如GPT-3.5)

---

**文档版本**: v1.0
**创建日期**: 2025年11月1日
**最后更新**: 2025年11月1日
**负责人**: [你的姓名]
**指导教师**: 范丰龙
