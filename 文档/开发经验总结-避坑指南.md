# 🚀 开发经验总结 - 避坑指南

> 本文档记录了实际开发中遇到的所有问题、错误和解决方案，适用于任何语言和技术栈

## 📋 目录

1. [前后端协调问题](#前后端协调问题)
2. [端口配置问题](#端口配置问题)
3. [数据库连接问题](#数据库连接问题)
4. [API集成问题](#api集成问题)
5. [配置文件问题](#配置文件问题)
6. [开发原则](#开发原则)

---

## 🔗 前后端协调问题

### 问题1: 配置名称不一致

**现象**：
- 前端无法连接数据库
- 报错：连接字符串未配置

**根本原因**：
- 原项目使用：`ConnectionStrings:BookDatabase`
- WebAPI项目使用：`ConnectionStrings:DefaultConnection`
- 配置名称不一致导致无法读取

**解决方案**：
```
✅ 统一配置名称
✅ 检查所有项目的配置文件
✅ 确保配置键名完全一致
```

**通用原则**：
> **在多项目/多模块开发中，必须先统一配置规范，包括：**
> - 配置文件名称
> - 配置键名
> - 环境变量名
> - 连接字符串格式

### 问题2: 前后端端口不匹配

**现象**：
- 前端报错：`Failed to fetch`
- CORS错误

**根本原因**：
- 前端运行在随机端口（5062）
- 后端CORS只允许5000端口
- 端口配置未固定

**解决方案**：
```
✅ 固定前端端口：修改 launchSettings.json
✅ 固定后端端口：修改 launchSettings.json
✅ 更新CORS配置：匹配实际端口
```

**通用原则**：
> **端口配置三原则：**
> 1. 固定端口，不要使用随机端口
> 2. 前后端端口配置要协调一致
> 3. CORS配置必须包含所有实际使用的端口

---

## 🔌 端口配置问题

### 问题3: 端口冲突处理不当

**错误做法**：
```
❌ 直接修改端口号来解决冲突
❌ 使用随机端口
❌ 频繁更改端口配置
```

**正确做法**：
```
✅ 先关闭占用端口的进程
✅ 保持端口配置不变
✅ 使用固定端口便于调试
```

**通用原则**：
> **端口冲突解决流程：**
> 1. 检查端口占用：`netstat -ano | findstr :端口号`
> 2. 关闭占用进程：`taskkill /F /PID 进程ID`
> 3. 等待端口释放：`timeout /t 3`
> 4. 重新启动服务
> 
> **永远不要为了解决端口冲突而修改配置！**

---

## 💾 数据库连接问题

### 问题4: Docker容器未启动

**现象**：
- 数据库连接超时
- Error 258: Wait timeout

**根本原因**：
- SQL Server Docker容器未运行
- 或刚启动还未完全就绪

**解决方案**：
```bash
# 1. 检查容器状态
docker ps -a

# 2. 启动容器
docker start <容器名>

# 3. 等待容器完全启动（5-10秒）
timeout /t 5

# 4. 再启动应用
```

**通用原则**：
> **依赖服务启动顺序：**
> 1. 数据库/缓存等基础服务
> 2. 等待服务完全就绪
> 3. 后端API服务
> 4. 前端应用
> 
> **不要假设服务已经启动，要主动检查！**

### 问题5: 数据库配置不统一

**现象**：
- 部分服务能连接，部分不能
- 配置文件中连接字符串不一致

**根本原因**：
- 多个配置文件存在
- 配置键名不统一
- 连接字符串格式不同

**解决方案**：
```
✅ 统一配置键名
✅ 使用相同的连接字符串
✅ 集中管理配置文件
```

**通用原则**：
> **配置管理最佳实践：**
> - 使用配置中心或环境变量
> - 避免硬编码
> - 所有项目使用相同的配置键名
> - 文档化所有配置项

---

## 🌐 API集成问题

### 问题6: API端点路径错误

**现象**：
- 404 Not Found
- Service request failed

**根本原因**：
- Ollama需要 `/v1` 路径才是OpenAI兼容端点
- 配置中只写了 `http://localhost:11434`
- 缺少必要的路径后缀

**解决方案**：
```csharp
// ❌ 错误
endpoint: new Uri("http://localhost:11434")

// ✅ 正确
endpoint: new Uri("http://localhost:11434/v1")
```

**通用原则**：
> **API集成检查清单：**
> - [ ] 确认完整的API端点URL（包括路径）
> - [ ] 查看API文档确认端点格式
> - [ ] 测试API是否可访问（curl/Postman）
> - [ ] 检查是否需要特殊的路径或版本号
> 
> **不要假设API端点格式，务必查看文档！**

### 问题7: 请求超时

**现象**：
- AbortError: The user aborted a request
- 请求被中断

**根本原因**：
- AI模型响应时间长（10-30秒）
- 默认超时时间太短（100秒）
- 前端等不及就中断了

**解决方案**：
```csharp
// 增加超时时间
new HttpClient 
{ 
    Timeout = TimeSpan.FromMinutes(5) 
}
```

**通用原则**：
> **超时配置原则：**
> - AI/ML服务：5分钟以上
> - 普通API：30-60秒
> - 数据库查询：30秒
> - 文件上传：根据文件大小调整
> 
> **根据实际业务场景设置合理的超时时间！**

---

## ⚙️ 配置文件问题

### 问题8: CORS配置不完整

**现象**：
- 前端能访问某些端口，但不能访问其他端口
- CORS错误

**根本原因**：
- CORS只配置了预期端口
- 实际运行端口不同
- 配置未覆盖所有情况

**解决方案**：
```csharp
// 包含所有可能的端口
policy.WithOrigins(
    "http://localhost:5000",   // HTTP
    "https://localhost:5001",  // HTTPS
    "http://localhost:5062",   // 备用端口
    "https://localhost:7062"   // HTTPS备用
)
```

**通用原则**：
> **CORS配置原则：**
> - 开发环境：允许所有本地端口
> - 生产环境：只允许特定域名
> - 记录所有允许的来源
> - 定期审查CORS配置

---

## 💡 开发原则

### 原则1: 不要使用模拟数据

**错误做法**：
```
❌ 遇到数据库问题就用模拟数据
❌ 为了快速测试使用假数据
❌ 绕过问题而不是解决问题
```

**正确做法**：
```
✅ 从根本解决数据库连接问题
✅ 使用真实数据测试
✅ 确保开发环境与生产环境一致
```

**原因**：
- 模拟数据隐藏真实问题
- 后期切换真实数据会出现新问题
- 浪费时间维护两套逻辑

### 原则2: 配置优先于硬编码

**错误做法**：
```csharp
❌ var url = "http://localhost:5001";
❌ var timeout = 100;
❌ var dbName = "BookLibrary";
```

**正确做法**：
```csharp
✅ var url = configuration["ApiUrl"];
✅ var timeout = configuration.GetValue<int>("Timeout");
✅ var dbName = configuration.GetConnectionString("Database");
```

### 原则3: 日志记录要详细

**错误做法**：
```csharp
❌ catch (Exception ex) { return "错误"; }
❌ _logger.LogError("失败");
```

**正确做法**：
```csharp
✅ catch (Exception ex) 
{
    _logger.LogError(ex, "操作失败: {Details}", details);
    return $"错误: {ex.Message}";
}
```

**原因**：
- 详细日志帮助快速定位问题
- 错误信息要包含上下文
- 生产环境问题排查依赖日志

### 原则4: 先检查依赖再启动

**启动顺序检查清单**：
```
1. [ ] Docker Desktop 已启动
2. [ ] 数据库容器正在运行
3. [ ] 数据库已初始化
4. [ ] AI服务（Ollama）正在运行
5. [ ] 端口未被占用
6. [ ] 配置文件正确
7. [ ] 启动后端API
8. [ ] 启动前端应用
```

### 原则5: 错误要返回给用户

**错误做法**：
```csharp
❌ return "抱歉，出现了问题";  // 用户不知道什么问题
```

**正确做法**：
```csharp
✅ return $"数据库连接失败: {ex.Message}";  // 明确的错误信息
✅ return $"API请求超时，请稍后重试";      // 可操作的建议
```

---

## 🔍 问题排查流程

### 通用排查步骤

```
1. 查看错误信息
   ├─ 前端：浏览器控制台 (F12)
   ├─ 后端：终端日志
   └─ 数据库：容器日志

2. 确认服务状态
   ├─ 数据库是否运行
   ├─ API是否启动
   └─ 端口是否正确

3. 检查配置
   ├─ 配置文件是否存在
   ├─ 配置键名是否正确
   └─ 配置值是否有效

4. 验证连接
   ├─ 网络是否通畅
   ├─ 防火墙是否阻止
   └─ CORS是否配置

5. 查看日志
   ├─ 错误堆栈
   ├─ 请求路径
   └─ 响应状态码
```

---

## 📊 常见错误速查表

| 错误信息 | 可能原因 | 解决方案 |
|---------|---------|---------|
| Failed to fetch | 后端未启动/端口错误 | 检查后端服务和端口 |
| 404 Not Found | API路径错误 | 检查端点URL |
| 500 Internal Server Error | 后端代码错误 | 查看后端日志 |
| CORS Error | 跨域配置问题 | 检查CORS设置 |
| Connection timeout | 数据库未启动 | 启动数据库容器 |
| Error 258 | 数据库等待超时 | 等待数据库完全启动 |
| AbortError | 请求超时 | 增加超时时间 |
| 配置未找到 | 配置键名错误 | 统一配置名称 |

---

## ✅ 开发检查清单

### 启动项目前

- [ ] 所有依赖服务已启动
- [ ] 配置文件已检查
- [ ] 端口未被占用
- [ ] 数据库已初始化

### 添加新功能前

- [ ] 了解现有架构
- [ ] 检查配置是否需要更新
- [ ] 确认API端点
- [ ] 规划错误处理

### 提交代码前

- [ ] 代码已测试
- [ ] 日志已添加
- [ ] 配置已文档化
- [ ] 错误信息清晰

### 部署前

- [ ] 所有配置已更新
- [ ] 端口已确认
- [ ] 依赖服务已准备
- [ ] 回滚方案已准备

---

## 🎯 总结

### 核心经验

1. **配置统一** - 所有项目使用相同的配置规范
2. **端口固定** - 不要随意修改端口配置
3. **真实数据** - 不使用模拟数据绕过问题
4. **详细日志** - 记录足够的信息用于排查
5. **依赖检查** - 启动前确认所有依赖就绪
6. **错误透明** - 向用户返回明确的错误信息
7. **文档先行** - 查看API文档而不是猜测

### 效率提升建议

- 创建启动脚本自动检查依赖
- 使用配置模板避免重复配置
- 建立错误代码对照表
- 记录所有配置项的用途
- 定期审查和更新配置

---

**最后更新**: 2025-11-02  
**适用范围**: 所有语言和技术栈  
**维护原则**: 每次遇到新问题都要更新此文档
